using System;
using System.IO;
using System.Reflection;
using Rnwood.Dataverse.Data.PowerShell.XrmToolboxPlugin;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;
using System.ComponentModel.Composition;

namespace Rnwood.Dataverse.Data.PowerShell.XrmToolboxPluginLoader
{
    [Export(typeof(IXrmToolBoxPlugin)),
    ExportMetadata("Name", "PowerShell Scripting Workspace"),
    ExportMetadata("Description", "Provides an integrated scripting environment using PowerShell"),
    // Please specify the base64 content of a 32x32 pixels image
    ExportMetadata("SmallImageBase64", "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"),
    // Please specify the base64 content of a 80x80 pixels image
    ExportMetadata("BigImageBase64", "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"),
    ExportMetadata("BackgroundColor", "Lavender"),
    ExportMetadata("PrimaryFontColor", "Black"),
    ExportMetadata("SecondaryFontColor", "Gray")]   
    public class PluginLoader : PluginBase
    {
        static PluginLoader()
        {
            try
            {
                string loaderDir = Path.GetDirectoryName(AppContext.BaseDirectory);
                string pluginSubdir = Path.Combine(loaderDir, "Rnwood.Dataverse.Data.PowerShell.XrmToolboxPlugin");

                AppDomain.CurrentDomain.AssemblyResolve += (sender, args) =>
                {

                    string assemblyName = new AssemblyName(args.Name).Name;
                    string dllPath = Path.Combine(pluginSubdir, assemblyName + ".dll");

                    if (File.Exists(dllPath))
                    {
                        return Assembly.LoadFrom(dllPath);
                    }


                    return null;
                };
            }
            catch (Exception ex)
            {
                // Log or handle the exception as needed
                Console.WriteLine($"Failed to set up assembly resolve event: {ex.Message}");
            }
        }

        public override IXrmToolBoxPluginControl GetControl()
        {
            return new PowerShellConsolePlugin();
        }
    }
}