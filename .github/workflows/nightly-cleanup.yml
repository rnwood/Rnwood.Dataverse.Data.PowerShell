name: Nightly E2E Test Cleanup

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v5
      
      - name: Install PowerShell 7
        uses: PSModule/install-powershell@v1
        with:
          Version: latest
      
      - name: Build module
        shell: pwsh
        run: |
          dotnet build -c Release
      
      - name: Import module
        shell: pwsh
        run: |
          Import-Module ./Rnwood.Dataverse.Data.PowerShell/bin/Release/netstandard2.0/Rnwood.Dataverse.Data.PowerShell.psd1 -Force
          Get-Module Rnwood.Dataverse.Data.PowerShell
      
      - name: Run cleanup script
        shell: pwsh
        env:
          E2ETESTS_URL: ${{ secrets.E2ETESTS_URL }}
          E2ETESTS_CLIENTID: ${{ secrets.E2ETESTS_CLIENTID }}
          E2ETESTS_CLIENTSECRET: ${{ secrets.E2ETESTS_CLIENTSECRET }}
        run: |
          ./scripts/Cleanup-E2ETestArtifacts.ps1 `
            -Url $env:E2ETESTS_URL `
            -ClientId $env:E2ETESTS_CLIENTID `
            -ClientSecret $env:E2ETESTS_CLIENTSECRET `
            -OlderThanHours 24 `
            -Verbose
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Nightly E2E cleanup failed',
              body: `The nightly E2E test cleanup workflow failed. Please check the logs: ${context.payload.repository.html_url}/actions/runs/${context.runId}`,
              labels: ['bug', 'ci']
            })
