# SV003: Managed Subcomponent Not Customized

## Rule Description

Managed table subcomponents (attributes, relationships, forms, views, etc.) should only be included in a solution if they have been customized.

## Severity

**Warning** - This should be reviewed and cleaned up when possible.

## Why This Matters

Including unmodified managed subcomponents in your solution is similar to the issue described in [SV002](SV002.md), but specifically applies to table subcomponents like:
- Attributes (fields)
- Relationships
- Forms
- Views
- Keys
- Business rules

### 1. Unnecessary Overhead
Unmodified managed subcomponents don't add value but increase solution complexity:
- Larger solution files
- Longer import/export times
- More components to track and maintain
- Harder to identify what actually changed

### 2. Maintenance Burden
When reviewing or troubleshooting your solution:
- It's unclear which components are intentionally customized
- Developers waste time investigating components that weren't actually changed
- Solution audits become more time-consuming

### 3. Upgrade Complications
When the base managed solution is upgraded:
- Your unmodified copies may conflict with updated versions
- You may need to update your solution to align with the base solution
- Import order and dependencies become more complex

### 4. Layering Issues
Dataverse uses solution layering to manage customizations. Including unmodified managed components:
- Creates unnecessary layers in the stack
- Can hide actual customizations from other solutions
- Makes it harder to understand the effective customization state

## Common Scenarios

### Scenario 1: Forms from Managed Tables
You added a managed table to your solution and accidentally included all its forms, even though you only customized one:

**Problem:**
- Main form (not customized) ✗
- Quick create form (not customized) ✗
- Custom form (customized) ✓

**Solution:** Remove the unmodified forms, keep only the customized one.

### Scenario 2: Standard Attributes
You're working with the Contact table and your solution includes standard attributes like `firstname`, `lastname` that you didn't modify:

**Problem:** Including these standard attributes provides no value.

**Solution:** Remove them from the solution unless you've added custom business logic, modified properties, or changed security settings.

### Scenario 3: Relationships
Your solution includes managed many-to-many relationships that are defined by the base solution and unchanged:

**Problem:** These relationships will work fine without being in your solution.

**Solution:** Remove them and rely on the base solution to provide these relationships.

## How to Fix

### 1. Identify Unmodified Subcomponents
```powershell
# Find all managed subcomponents that aren't customized
$issues = Test-DataverseSolution -Connection $conn -UniqueName MySolution

$issues.Issues | Where-Object { $_.RuleId -eq 'SV003' } | Format-Table
```

### 2. Remove Unmodified Subcomponents
```powershell
# Remove specific subcomponents
Remove-DataverseSolutionComponent -Connection $conn -SolutionName MySolution `
    -ComponentType $componentType -ComponentId $componentId
```

### 3. Review Parent Table Behavior
Check if the parent table is included with "Include Subcomponents":
```powershell
Get-DataverseSolutionComponent -Connection $conn -SolutionName MySolution | 
    Where-Object { $_.ComponentType -eq 1 -and $_.Behavior -eq 'IncludeSubcomponents' }
```

If so, consider changing to "Do Not Include Subcomponents" and explicitly adding only customized subcomponents.

## What Counts as "Customized"?

A subcomponent is considered customized if you've:
- **Attributes**: Changed properties, added validation, modified security
- **Forms**: Modified layout, added/removed fields, changed scripts
- **Views**: Modified columns, changed filters, adjusted sorting
- **Relationships**: Modified mappings or other properties (rare for managed components)
- **Business Rules**: Modified logic or conditions

If you haven't changed any of these aspects, the subcomponent is not customized and shouldn't be in your solution.

## Best Practices

### 1. Use "Do Not Include Subcomponents"
When adding managed tables to your solution:
```powershell
# Add the table without subcomponents
Set-DataverseSolutionComponent -Connection $conn -SolutionName MySolution `
    -ComponentType 1 -ComponentId $entityId -DoNotIncludeSubcomponents

# Then add only what you've customized
Set-DataverseSolutionComponent -Connection $conn -SolutionName MySolution `
    -ComponentType 60 -ComponentId $customizedFormId
```

### 2. Regular Cleanup
Periodically run validation to ensure your solution stays clean:
```powershell
# Schedule regular validation checks
Test-DataverseSolution -Connection $conn -UniqueName MySolution -Verbose
```

### 3. Solution Reviews
During code reviews, check the solution components to ensure only necessary items are included.

## Example: Cleaning Up a Solution

```powershell
# 1. Validate the solution
$results = Test-DataverseSolution -Connection $conn -UniqueName MySolution

# 2. Find SV003 violations
$sv003Issues = $results.Issues | Where-Object { $_.RuleId -eq 'SV003' }

Write-Host "Found $($sv003Issues.Count) unmodified managed subcomponents"

# 3. Review and remove each one
foreach ($issue in $sv003Issues) {
    Write-Host "Removing: $($issue.ComponentTypeName) - $($issue.ComponentIdentifier)"
    
    # Parse component ID from identifier (adjust based on your needs)
    if ($issue.Details.ContainsKey('ObjectId')) {
        Remove-DataverseSolutionComponent -Connection $conn `
            -SolutionName MySolution `
            -ComponentType $issue.ComponentType `
            -ComponentId $issue.Details['ObjectId']
    }
}

# 4. Validate again to confirm cleanup
$cleanResults = Test-DataverseSolution -Connection $conn -UniqueName MySolution
Write-Host "After cleanup: $($cleanResults.Issues.Count) total issues remaining"
```

## When It's Acceptable

In rare cases, you might intentionally include an unmodified subcomponent:
- **Patching scenarios** where you need to reference the component
- **Deployment orchestration** where explicit dependencies are required
- **Documentation purposes** (though this is better handled through solution dependencies)

Always document these exceptions clearly.

## Related Documentation

- [Solution layers and customizations](https://learn.microsoft.com/en-us/power-platform/alm/solution-layers-alm)
- [Component management best practices](https://learn.microsoft.com/en-us/power-platform/alm/solution-concepts-alm)

## See Also

- [SV001: Managed Table Include Subcomponents](SV001.md)
- [SV002: Managed Non-Table Not Customized](SV002.md)
