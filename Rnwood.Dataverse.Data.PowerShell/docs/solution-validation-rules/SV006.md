# SV006: Shared Unmanaged Component

## Rule Description

Solution should not include unmanaged components or subcomponents that are already in other unmanaged solutions. Shared unmanaged components can cause ownership conflicts and deployment issues.

## Severity

**Error** - This issue should be fixed before deploying the solution.

## Why This Matters

When unmanaged components are shared across multiple unmanaged solutions, several critical issues arise:

### 1. Ownership Conflicts

- **Ambiguous ownership**: Multiple solutions claim the same component
- **Unpredictable behavior**: Changes in one solution affect others
- **Difficult troubleshooting**: Hard to determine which solution owns the component
- **Layering issues**: Solution layers become complex and confusing

### 2. Deployment Problems

- **Import failures**: Solutions may fail to import due to conflicts
- **Dependency confusion**: Unclear which solution should be deployed first
- **Broken references**: Components may reference wrong solution layers
- **Rollback difficulties**: Hard to revert changes when components are shared

### 3. Maintenance Nightmares

- **Change tracking**: Difficult to know which solution changed what
- **Testing complexity**: Need to test all solutions when changing shared component
- **Version conflicts**: Different solutions may expect different versions
- **Release coupling**: Can't release solutions independently

### 4. Solution Architecture Issues

- **Blurred boundaries**: Solution boundaries become unclear
- **Technical debt**: Shared components create long-term maintenance burden
- **Scalability problems**: Can't scale or split solutions easily
- **Team conflicts**: Multiple teams modifying same components

## How This Rule Works

This rule **always runs** and:

1. Identifies all unmanaged components in the current solution
2. Queries the `solutioncomponent` table to find other solutions containing these components
3. Filters to only unmanaged solutions (excludes managed solutions)
4. Excludes system and hidden solutions (Default, Active, System, msdyn_*, etc.)
5. Excludes solutions matching patterns in `-IgnoreSharedComponentSolutions` parameter
6. Reports violations for any remaining shared components

## Configuration

### Ignore Specific Solutions

Use the `-IgnoreSharedComponentSolutions` parameter to exclude certain solutions from the check:

```powershell
Test-DataverseSolution -UniqueName "MySolution" `
    -IgnoreSharedComponentSolutions @("CommonComponents", "SharedLib*") `
    -Verbose
```

This allows sharing with:
- "CommonComponents" (exact match)
- Any solution starting with "SharedLib" (e.g., "SharedLibraries", "SharedLibV2")

### Wildcard Patterns

Supports standard wildcards:
- `*` matches zero or more characters
- `?` matches exactly one character

**Examples:**
- `Shared*` matches "Shared", "SharedUtils", "SharedComponents"
- `*Common` matches "TeamCommon", "OrgCommon"
- `Platform?` matches "Platform1", "PlatformA" but not "Platform" or "Platform12"

## Common Scenarios

### Scenario 1: Accidental Component Duplication

**Problem:**
- Developer adds table to "FeatureA" solution
- Same table is already in "FeatureB" solution
- Both solutions now share the table

**Detection:**
```powershell
Test-DataverseSolution -UniqueName "FeatureA" -Verbose

# Output shows:
# [SV006] Unmanaged component 'new_customtable' is shared with other 
# unmanaged solution(s): 'FeatureB'. Shared unmanaged components can 
# cause ownership conflicts.
```

**Fix:**
1. Determine which solution should own the component
2. Remove from the other solution
3. If both need it, create a shared foundation solution
4. Add to foundation solution, reference from both features

### Scenario 2: Shared Foundation Components

**Problem:**
- Multiple solutions intentionally share components from "Foundation" solution
- Want to allow this pattern

**Configuration:**
```powershell
Test-DataverseSolution -UniqueName "FeatureA" `
    -IgnoreSharedComponentSolutions @("Foundation", "SharedPlatform") `
    -Verbose
```

**Result:**
- Components shared with "Foundation" or "SharedPlatform" are not reported
- Components shared with other solutions still trigger violations

### Scenario 3: Migrating from Shared to Layered

**Problem:**
- Legacy architecture has shared components across solutions
- Migrating to proper layered architecture

**Approach:**
```powershell
# Initially downgrade to warning to track progress
Test-DataverseSolution -UniqueName "LegacySolution" `
    -OverrideSeverity @("SV006:Warning") `
    -Verbose

# As you fix violations, eventually enforce as error
Test-DataverseSolution -UniqueName "LegacySolution" `
    -FailOnSeverity Error
```

## Fixing Violations

### Step 1: Identify Shared Components

Review the validation output to understand:
- Which components are shared
- Which other solutions contain them
- Whether sharing is intentional or accidental

### Step 2: Choose Fix Strategy

#### Option A: Remove from One Solution

If one solution doesn't need the component:
1. Open the solution that shouldn't have it
2. Remove the component
3. Re-export the solution
4. Test to ensure functionality still works

#### Option B: Create Foundation Solution

If multiple solutions legitimately need the component:
1. Create a new "Foundation" or "Shared" solution
2. Move the shared component to the foundation solution
3. Remove from original solutions
4. Have original solutions reference the foundation solution
5. Add foundation to ignored patterns:
   ```powershell
   -IgnoreSharedComponentSolutions @("Foundation")
   ```

#### Option C: Duplicate Component

If components are truly independent:
1. Rename component in one solution to make unique
2. Update all references in that solution
3. Components are now separate and can evolve independently

### Step 3: Verify Fix

```powershell
Test-DataverseSolution -UniqueName "MySolution" -Verbose

# Should show no SV006 violations
```

## Best Practices

### 1. Clear Solution Architecture

Define solution layers:
```
Foundation Layer (shared components)
    ↓
Platform Layer (shared services)
    ↓
Application Layer (business solutions)
```

Only foundation/platform solutions should be in ignore patterns.

### 2. Component Ownership

Establish clear rules:
- **One owner per component**: Each component belongs to exactly one solution
- **Explicit sharing**: Use foundation solutions for intentional sharing
- **Document patterns**: Maintain list of allowed shared solutions

### 3. Configuration Management

Store validation configuration in source control:
```powershell
# validate-solution.ps1
$standardIgnores = @("Foundation", "SharedPlatform", "CommonUtils")

Test-DataverseSolution -UniqueName $solutionName `
    -IgnoreSharedComponentSolutions $standardIgnores `
    -FailOnSeverity Error `
    -ErrorAction Stop
```

### 4. CI/CD Integration

Add to build pipeline:
```powershell
# Fail build if unintended sharing detected
$results = Test-DataverseSolution -UniqueName "MySolution" `
    -IgnoreSharedComponentSolutions @("Foundation", "SharedLib*") `
    -FailOnSeverity Error `
    -ErrorAction Stop

if ($results.Issues | Where-Object { $_.RuleId -eq "SV006" }) {
    throw "Component sharing detected! Components must not be shared across unmanaged solutions."
}
```

### 5. Gradual Migration

For legacy solutions with many violations:
```powershell
# Phase 1: Downgrade to warning, track count
$results = Test-DataverseSolution -UniqueName "Legacy" `
    -OverrideSeverity @("SV006:Warning")
Write-Host "SV006 violations: $($results.Issues | Where-Object { $_.RuleId -eq 'SV006' }).Count)"

# Phase 2: Set target and fail if exceeded
$sv006Count = ($results.Issues | Where-Object { $_.RuleId -eq 'SV006' }).Count
if ($sv006Count -gt 10) {
    throw "Too many SV006 violations! Target: 10, Actual: $sv006Count"
}

# Phase 3: Eventually enforce as error
Test-DataverseSolution -UniqueName "Legacy" -FailOnSeverity Error
```

## Example Output

```powershell
PS C:\> Test-DataverseSolution -UniqueName "FeatureSolution" -Verbose

VERBOSE: Starting validation of solution 'FeatureSolution'...
VERBOSE: Running 6 validation rule(s)
VERBOSE: Validating Rule SV006: Shared Unmanaged Component...
VERBOSE: Rule SV006: Checking 45 unmanaged component(s) for sharing
VERBOSE: Rule SV006: Found 3 violation(s)

SolutionUniqueName : FeatureSolution
IsValid            : False
Issues             : {
    RuleId: SV006
    Severity: Error
    Message: Unmanaged component 'new_customtable' is shared with other 
             unmanaged solution(s): 'OtherFeature', 'LegacySolution'. 
             Shared unmanaged components can cause ownership conflicts.
    
    RuleId: SV006
    Severity: Error
    Message: Unmanaged subcomponent 'new_customfield' is shared with other 
             unmanaged solution(s): 'OtherFeature'. Shared unmanaged 
             components can cause ownership conflicts.
}
```

## Related Documentation

- [Solution concepts in Dataverse](https://learn.microsoft.com/en-us/power-platform/alm/solution-concepts-alm)
- [Solution layers](https://learn.microsoft.com/en-us/power-platform/alm/solution-layers-alm)
- [Managed vs unmanaged solutions](https://learn.microsoft.com/en-us/power-apps/maker/data-platform/solutions-overview)

## See Also

- [SV001: Managed Table Include Subcomponents](SV001.md)
- [SV002: Managed Non-Table Not Customized](SV002.md)
- [SV003: Managed Subcomponent Not Customized](SV003.md)
- [SV004: Unauthorized Dependency](SV004.md)
- [SV005: Unsolutioned Dependency](SV005.md)
