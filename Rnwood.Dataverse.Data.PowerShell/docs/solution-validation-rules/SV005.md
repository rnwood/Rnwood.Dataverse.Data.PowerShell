# SV005: Unsolutioned Dependency

## Rule Description

Solution components should not depend on components that are not in any solution or are in system/hidden solutions. Such dependencies indicate unmanaged or system components that may not be properly deployed or consistently available.

## Severity

**Error** - This issue should be fixed before deploying the solution.

## Why This Matters

Dependencies on unsolutioned or system/hidden solution components create significant deployment and maintenance risks:

### 1. Unsolutioned Components

Components not included in any solution are:
- **Not deployed**: Unsolutioned components won't be included when you export/import solutions
- **Environment-specific**: They exist only in the environment where they were created
- **Untracked**: No version control or change history
- **Unreliable**: Can be modified or deleted without warning

### 2. System/Hidden Solution Dependencies

System and hidden solutions:
- **May not exist** in all environments (development, test, production)
- **Can't be controlled**: You can't manage or version these solutions
- **May change**: Microsoft can update system solutions without notice
- **Are environment-specific**: Different environments may have different system solutions

### 3. Deployment Failures

When your solution depends on unsolutioned or system components:
- **Import fails**: Solution import may fail if dependencies aren't present
- **Broken functionality**: Features may work in dev but fail in production
- **Missing components**: Required components may not be available
- **Difficult troubleshooting**: Errors are often cryptic and hard to diagnose

### 4. Maintenance Issues

Over time, these dependencies cause:
- **Technical debt**: Future changes become increasingly difficult
- **Fragile solutions**: Small changes can cause unexpected failures
- **Hard-to-reproduce bugs**: Issues that only occur in certain environments
- **Solution bloat**: Workarounds add complexity to work around missing dependencies

## How This Rule Works

This rule **always runs** (unlike SV004 which is opt-in) and:

1. Examines all components in your solution
2. Queries their dependencies (required components)
3. For each dependency, checks if it's in a solution
4. Excludes system and hidden solutions from consideration
5. Flags components that:
   - Are not in any solution (unsolutioned)
   - Are in system solutions (e.g., "System", "msdyn_*", "Microsoft*")
   - Are in hidden solutions (isvisible = false)

## System Solution Patterns

The rule identifies system solutions by checking for these prefixes:
- `System`
- `Basic`
- `msdyn_` (Dynamics 365 apps)
- `msdynce_` (Dynamics CE)
- `msft_` (Microsoft first-party)
- `Microsoft`
- `Internal`

## Common Scenarios

### Scenario 1: Unsolutioned Custom Component

**Problem:**
- Your solution's entity references a custom field
- The custom field was created directly in the environment (not added to a solution)

**Detection:**
```powershell
Test-DataverseSolution -UniqueName "MySolution" -Verbose

# Output shows:
# [SV005] Component 'new_myentity' depends on a component (ID: xxx) that is 
# not in any solution. Unsolutioned dependencies may not be deployed correctly.
```

**Fix:**
1. Identify the unsolutioned component
2. Create a new solution or use an existing one
3. Add the component to that solution
4. Add the solution as a required dependency
5. Re-export your solution

### Scenario 2: System Solution Dependency

**Problem:**
- Your solution depends on a component from a system solution like "msdyn_SalesProApp"

**Detection:**
```powershell
Test-DataverseSolution -UniqueName "MySolution" -Verbose

# Output shows:
# [SV005] Component 'new_customentity' depends on a component from 
# system/hidden solution 'msdyn_SalesProApp'. System solution dependencies 
# should be avoided.
```

**Fix:**
1. Determine if the dependency is necessary
2. If necessary, copy/recreate the required component in your own managed solution
3. Update references to point to your copy
4. Remove dependency on system solution

### Scenario 3: Hidden Solution Dependency

**Problem:**
- Your solution references components from a hidden internal solution

**Detection:**
```powershell
Test-DataverseSolution -UniqueName "MySolution" -Verbose

# Output shows dependency on hidden solution
```

**Fix:**
1. Identify what component you need from the hidden solution
2. Create your own version in a visible, managed solution
3. Update your solution to reference your version

## Fixing Violations

### Step 1: Identify the Dependency

Review the error message to understand:
- Which component in your solution has the issue
- What component it depends on (component ID provided)
- Whether it's unsolutioned or in a system/hidden solution

### Step 2: Locate the Component

Use Power Apps or Dataverse tools to find the component:
```powershell
# Query to find component details
$componentId = [Guid]"xxx-xxx-xxx"
# Use maker portal or API to inspect component
```

### Step 3: Choose Appropriate Fix

#### Option A: Add to Solution (for unsolutioned components)

If the component should be deployed:
1. Create or identify target solution
2. Add component to solution
3. Update dependencies in your solution

#### Option B: Recreate Component (for system dependencies)

If you need the functionality:
1. Create your own version of the component
2. Place in a managed solution you control
3. Update references to use your version

#### Option C: Remove Dependency (if not needed)

If the dependency is accidental:
1. Refactor code to remove the reference
2. Update solution to eliminate dependency

### Step 4: Verify Fix

After making changes:
```powershell
Test-DataverseSolution -UniqueName "MySolution" -Verbose

# Should show no SV005 violations
```

## Best Practices

### 1. Always Use Solutions

- Add ALL custom components to solutions
- Never create "loose" components in the environment
- Use solution layers for all customizations

### 2. Avoid System Dependencies

- Don't reference system solution components directly
- If you need system functionality, abstract it
- Create your own wrapper components

### 3. Solution Architecture

Create a clear solution hierarchy:
```
Foundation Solutions (base components)
    ↓
Platform Solutions (shared services)
    ↓
Application Solutions (business apps)
```

Each layer should only reference components in solutions at the same or lower layers.

### 4. Dependency Documentation

Document all inter-solution dependencies:
- What components are shared
- Which solutions must be deployed together
- Deployment order requirements

### 5. CI/CD Integration

Add to your build pipeline:
```powershell
# Fail build if unsolutioned dependencies detected
$results = Test-DataverseSolution -UniqueName "MySolution" `
    -FailOnSeverity Error `
    -ErrorAction Stop

if ($results.Issues | Where-Object { $_.RuleId -eq "SV005" }) {
    throw "Unsolutioned dependencies detected! All dependencies must be in solutions."
}
```

## Example Output

```powershell
PS C:\> Test-DataverseSolution -UniqueName "MySolution" -Verbose

VERBOSE: Starting validation of solution 'MySolution'...
VERBOSE: Running 5 validation rule(s)
VERBOSE: Validating Rule SV005: Unsolutioned Dependency...
VERBOSE: Rule SV005: Found 150 dependencies to check
VERBOSE: Rule SV005: Found 2 violation(s)

SolutionUniqueName : MySolution
IsValid            : False
Issues             : {
    RuleId: SV005
    Severity: Error
    Message: Component 'new_customentity' depends on a component (ID: 
             12345678-1234-1234-1234-123456789012) that is not in any solution. 
             Unsolutioned dependencies may not be deployed correctly.
    
    RuleId: SV005
    Severity: Error
    Message: Component 'new_myform' depends on a component from system/hidden 
             solution 'msdyn_DataInsightsAndAnalytics'. System solution 
             dependencies should be avoided as they may not be consistently 
             available across environments.
}
```

## Related Documentation

- [Solution concepts in Dataverse](https://learn.microsoft.com/en-us/power-platform/alm/solution-concepts-alm)
- [Dependency tracking](https://learn.microsoft.com/en-us/power-apps/developer/data-platform/dependency-tracking-solution-components)
- [Solution layering](https://learn.microsoft.com/en-us/power-platform/alm/solution-layers-alm)

## See Also

- [SV001: Managed Table Include Subcomponents](SV001.md)
- [SV002: Managed Non-Table Not Customized](SV002.md)
- [SV003: Managed Subcomponent Not Customized](SV003.md)
- [SV004: Unauthorized Dependency](SV004.md)
