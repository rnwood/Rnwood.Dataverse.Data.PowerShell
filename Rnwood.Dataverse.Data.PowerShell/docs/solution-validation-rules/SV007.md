# SV007: Environment Variable Value Included

## Rule Description

Solution should not include environment variable values. Environment variable values are environment-specific configuration and should be set in each target environment, not transported via solutions.

## Severity

**Error** - This issue must be fixed before deploying the solution.

## Why This Matters

Environment variable values should never be included in solutions because:

### 1. Environment-Specific Configuration

Environment variables are designed to hold configuration that varies by environment:
- **Development**: Connection strings, URLs, API keys for dev systems
- **Test**: Different endpoints and credentials for test systems
- **Production**: Production URLs, keys, and sensitive configuration

Including values in solutions means:
- Dev configuration gets deployed to production
- Test settings overwrite production settings
- Sensitive data from one environment leaks to others

### 2. Security Risks

Environment variable values often contain:
- **API keys and secrets**: Credentials that should be unique per environment
- **Connection strings**: Database or service URLs with embedded credentials
- **Access tokens**: Tokens that grant access to protected resources
- **Sensitive URLs**: Internal system addresses that shouldn't be exposed

Transporting these via solutions:
- Exposes secrets in solution exports (ZIP files)
- Makes secrets visible to anyone with solution access
- Creates security audit trail issues
- Violates principle of least privilege

### 3. Deployment Failures

When values are in solutions:
- **Import overwrites current values**: Existing environment configuration is lost
- **Wrong configuration applied**: Dev settings applied to production
- **Services fail**: Applications try to connect to wrong endpoints
- **Data corruption**: Wrong database connections can corrupt data

### 4. Configuration Management Issues

Including values in solutions causes:
- **No centralized configuration**: Each solution brings its own values
- **Difficult to update**: Must edit and redeploy solutions to change config
- **Version conflicts**: Multiple solutions may include conflicting values
- **No audit trail**: Can't track who changed configuration and when

## How Environment Variables Should Work

### Correct Pattern

1. **Include definitions in solution**: Environment variable definitions (schema, type, description)
2. **Exclude values from solution**: Values are NOT included
3. **Configure values in target environment**: After solution import, set values in each environment

### Example Workflow

```powershell
# 1. Export solution (definitions only, no values)
Export-DataverseSolution -Connection $conn -SolutionName "MySolution" -Path "export.zip"

# 2. Validate solution doesn't contain values
Test-DataverseSolution -Connection $conn -UniqueName "MySolution" -Verbose

# 3. Import to target environment
Import-DataverseSolution -Connection $targetConn -Path "export.zip"

# 4. Set environment-specific values in target
Set-DataverseRecord -Connection $targetConn `
    -TableName "environmentvariablevalue" `
    -Data @{
        environmentvariabledefinitionid = $definitionId
        value = "https://prod-api.example.com"
    }
```

## How This Rule Works

This rule **always runs** and:

1. Examines all components in the solution
2. Identifies components with type 380 (Environment Variable Value)
3. Queries details about each environment variable value
4. Reports each value as an Error severity violation

The rule catches:
- Environment variable values explicitly added to solution
- Values automatically included when "Include subcomponents" is selected
- Values carried over from previous solution versions

## Common Scenarios

### Scenario 1: Accidental Value Inclusion

**Problem:**
- Developer adds environment variable definition to solution
- Selects "Include all subcomponents"
- Value is automatically included

**Detection:**
```powershell
Test-DataverseSolution -UniqueName "MySolution" -Verbose

# Output shows:
# [SV007] Environment variable value 'myapp_ApiUrl' (for definition 
# 'myapp_ApiUrl') should not be included in the solution. Environment 
# variable values are environment-specific and should be configured in 
# each target environment, not transported via solutions.
```

**Fix:**
1. Open solution in maker portal
2. Locate the environment variable value component
3. Remove the value from the solution (keep definition)
4. Re-export the solution

### Scenario 2: Legacy Solution with Values

**Problem:**
- Older solution contains environment variable values
- Need to remove them before next deployment

**Detection:**
```powershell
Test-DataverseSolution -UniqueName "LegacySolution" -Verbose
```

**Fix:**
1. Create new version of solution
2. Remove all environment variable values
3. Document required values for deployment guide
4. Update deployment process to set values post-import

### Scenario 3: Multiple Environments with Different Values

**Problem:**
- Solution deployed to Dev, Test, Prod
- Each environment needs different API URLs

**Correct Approach:**
```powershell
# Solution contains only the definition
# After importing to each environment, set environment-specific value

# Development
Set-DataverseRecord -Connection $devConn `
    -TableName "environmentvariablevalue" `
    -Data @{
        environmentvariabledefinitionid = $definitionId
        value = "https://dev-api.example.com"
    }

# Production
Set-DataverseRecord -Connection $prodConn `
    -TableName "environmentvariablevalue" `
    -Data @{
        environmentvariabledefinitionid = $definitionId
        value = "https://api.example.com"
    }
```

## Fixing Violations

### Step 1: Identify Environment Variable Values

Review validation output to see which values are included:
```powershell
$results = Test-DataverseSolution -UniqueName "MySolution" -Verbose
$results.Issues | Where-Object { $_.RuleId -eq "SV007" }
```

### Step 2: Remove Values from Solution

**Option A: Using Power Apps Maker Portal**
1. Open solution in maker portal
2. Click "..." menu next to solution name
3. Select "Advanced" → "Solutions"
4. Find environment variable value components (type 380)
5. Select each value and click "Remove"
6. Save and publish changes

**Option B: Using PowerShell**
```powershell
# Get environment variable value components in solution
$query = @"
<fetch>
  <entity name='solutioncomponent'>
    <filter>
      <condition attribute='solutionid' operator='eq' value='$solutionId'/>
      <condition attribute='componenttype' operator='eq' value='380'/>
    </filter>
  </entity>
</fetch>
"@

$components = Get-DataverseRecord -Connection $conn -Query $query

# Remove each value component from solution
foreach ($component in $components) {
    Remove-DataverseRecord -Connection $conn `
        -TableName "solutioncomponent" `
        -Id $component.solutioncomponentid
}
```

### Step 3: Document Required Values

Create a deployment guide documenting:
- Which environment variables exist
- What values are needed in each environment
- How to set values post-deployment

**Example: deployment-guide.md**
```markdown
# Environment Variables

After importing the solution, set these environment variable values:

## myapp_ApiUrl
- **Description**: Base URL for API calls
- **Type**: Text
- **Development**: https://dev-api.example.com
- **Test**: https://test-api.example.com
- **Production**: https://api.example.com

## myapp_DatabaseConnectionString
- **Description**: Connection string for database
- **Type**: Secret
- **Set via**: Azure Key Vault reference
```

### Step 4: Update Deployment Process

Add post-import configuration step:
```powershell
# Import solution
Import-DataverseSolution -Connection $conn -Path "solution.zip"

# Configure environment variables
$envVars = @{
    "myapp_ApiUrl" = "https://api.example.com"
    "myapp_MaxRetries" = "3"
}

foreach ($envVar in $envVars.GetEnumerator()) {
    # Get definition ID
    $definition = Get-DataverseRecord -Connection $conn `
        -TableName "environmentvariabledefinition" `
        -Filter "schemaname eq '$($envVar.Key)'"
    
    # Set or update value
    Set-DataverseRecord -Connection $conn `
        -TableName "environmentvariablevalue" `
        -Data @{
            environmentvariabledefinitionid = $definition.environmentvariabledefinitionid
            value = $envVar.Value
        } `
        -MatchOn @("environmentvariabledefinitionid")
}
```

### Step 5: Verify Fix

```powershell
Test-DataverseSolution -UniqueName "MySolution" -Verbose

# Should show no SV007 violations
```

## Best Practices

### 1. Never Add Values to Solutions

When adding environment variables to solutions:
- ✅ Add the **definition** (schema, type, display name)
- ❌ Do NOT add the **value**

### 2. Use Solution Layers Correctly

- Keep definitions in foundational/platform solutions
- Never include values in any solution
- Set values directly in each environment

### 3. Automate Value Configuration

Create configuration scripts:
```powershell
# configure-environment.ps1
param(
    [Parameter(Mandatory=$true)]
    [ValidateSet('Dev', 'Test', 'Prod')]
    [string]$Environment
)

$values = @{
    Dev = @{
        "myapp_ApiUrl" = "https://dev-api.example.com"
        "myapp_LogLevel" = "Debug"
    }
    Test = @{
        "myapp_ApiUrl" = "https://test-api.example.com"
        "myapp_LogLevel" = "Info"
    }
    Prod = @{
        "myapp_ApiUrl" = "https://api.example.com"
        "myapp_LogLevel" = "Warning"
    }
}

# Apply environment-specific values
foreach ($var in $values[$Environment].GetEnumerator()) {
    Set-EnvironmentVariableValue -Name $var.Key -Value $var.Value
}
```

### 4. Use Secrets Management

For sensitive values:
```powershell
# Reference Azure Key Vault
Set-DataverseRecord -Connection $conn `
    -TableName "environmentvariablevalue" `
    -Data @{
        environmentvariabledefinitionid = $definitionId
        value = "/subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.KeyVault/vaults/{vault}/secrets/{secret}"
    }
```

### 5. CI/CD Integration

Add validation to build pipeline:
```powershell
# Fail build if environment variable values detected
$results = Test-DataverseSolution -UniqueName "MySolution" `
    -FailOnSeverity Error `
    -ErrorAction Stop

$envVarIssues = $results.Issues | Where-Object { $_.RuleId -eq "SV007" }
if ($envVarIssues) {
    throw "Environment variable values detected! Count: $($envVarIssues.Count)"
}
```

### 6. Document in README

Include in solution README:
```markdown
# Environment Configuration

This solution requires the following environment variables:

| Variable | Type | Purpose |
|----------|------|---------|
| myapp_ApiUrl | Text | API endpoint URL |
| myapp_ApiKey | Secret | API authentication key |

See `docs/environment-variables.md` for configuration instructions.
```

## Example Output

```powershell
PS C:\> Test-DataverseSolution -UniqueName "MySolution" -Verbose

VERBOSE: Starting validation of solution 'MySolution'...
VERBOSE: Running 7 validation rule(s)
VERBOSE: Validating Rule SV007: Environment Variable Value Included...
VERBOSE: Rule SV007: Found 2 environment variable value(s)
VERBOSE: Rule SV007: Found 2 violation(s)

SolutionUniqueName : MySolution
IsValid            : False
Issues             : {
    RuleId: SV007
    Severity: Error
    Message: Environment variable value 'myapp_ApiUrl' (for definition 
             'myapp_ApiUrl') should not be included in the solution. 
             Environment variable values are environment-specific and 
             should be configured in each target environment, not 
             transported via solutions.
    
    RuleId: SV007
    Severity: Error
    Message: Environment variable value 'myapp_ApiKey' (for definition 
             'myapp_ApiKey') should not be included in the solution. 
             Environment variable values are environment-specific and 
             should be configured in each target environment, not 
             transported via solutions.
}
```

## Related Documentation

- [Environment variables in Dataverse](https://learn.microsoft.com/en-us/power-apps/maker/data-platform/environmentvariables)
- [Use environment variables in solutions](https://learn.microsoft.com/en-us/power-platform/alm/environment-variables-alm)
- [Best practices for environment variables](https://learn.microsoft.com/en-us/power-platform/guidance/alm-accelerator/environment-variables)

## See Also

- [SV001: Managed Table Include Subcomponents](SV001.md)
- [SV002: Managed Non-Table Not Customized](SV002.md)
- [SV003: Managed Subcomponent Not Customized](SV003.md)
- [SV004: Unauthorized Dependency](SV004.md)
- [SV005: Unsolutioned Dependency](SV005.md)
- [SV006: Shared Unmanaged Component](SV006.md)
